<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AGP+ TDD Debug Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1, h2, h3 {
      border-bottom: 3px solid #000;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    
    .section {
      background: white;
      border: 3px solid #000;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    button {
      background: #000;
      color: white;
      border: none;
      padding: 12px 24px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #333;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    input[type="file"] {
      margin-bottom: 16px;
      font-family: 'Courier New', monospace;
    }
    
    .results {
      background: #fafafa;
      border: 2px solid #ddd;
      padding: 16px;
      margin-top: 16px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .day-card {
      background: white;
      border: 2px solid #000;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid #000;
    }
    
    .tdd-value {
      font-size: 18px;
      font-weight: bold;
      color: #000;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border: 2px solid #000;
      margin-right: 8px;
      font-size: 12px;
    }
    
    .badge-auto {
      background: #e0f2fe;
      border-color: #0891b2;
      color: #0891b2;
    }
    
    .badge-meal {
      background: #ffedd5;
      border-color: #f97316;
      color: #f97316;
    }
    
    .badge-tdd {
      background: #fef08a;
      border-color: #000;
      color: #000;
    }
    
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      overflow-x: auto;
      font-size: 12px;
    }
    
    .stats {
      background: #fef3c7;
      border: 3px solid #000;
      padding: 16px;
      margin-top: 16px;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 4px 0;
    }
    
    .stat-label {
      font-weight: bold;
    }
    
    .warning {
      background: #fee2e2;
      border: 2px solid #dc2626;
      padding: 12px;
      margin-top: 12px;
      color: #991b1b;
    }
    
    .info {
      background: #dbeafe;
      border: 2px solid #2563eb;
      padding: 12px;
      margin-top: 12px;
      color: #1e40af;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="margin-bottom: 20px;">
      <a href="index.html" style="color: #000; text-decoration: none; font-weight: bold;">‚Üê Terug naar Debug Tools</a>
    </div>
    
    <h1>ü©∫ AGP+ TDD Debug Tool</h1>
    <p style="margin-bottom: 20px;">Test Total Daily Dose calculation from CareLink CSV</p>
    
    <div class="section">
      <h2>1. Load CSV File</h2>
      <input type="file" id="csvFile" accept=".csv" />
      <button id="loadBtn" onclick="loadCSV()">Load & Parse</button>
    </div>
    
    <div class="section" id="section1Panel" style="display: none;">
      <h2>2. Section 1: Meal Boluses</h2>
      <div id="section1Results" class="results"></div>
    </div>
    
    <div class="section" id="section2Panel" style="display: none;">
      <h2>3. Section 2: Auto Insulin</h2>
      <div id="section2Results" class="results"></div>
    </div>
    
    <div class="section" id="tddPanel" style="display: none;">
      <h2>4. Total Daily Dose (TDD)</h2>
      <div id="tddResults" class="results"></div>
      <div id="tddStats" class="stats" style="display: none;"></div>
      <div id="validationResults"></div>
    </div>
  </div>

  <script type="module">
    import { parseCSV } from '/src/core/parsers.js';
    import { 
      calculateDailyTDD, 
      calculateTDDStatistics,
      validateTDDData 
    } from '/src/core/insulin-engine.js';
    
    let parsedData = null;
    
    window.loadCSV = async () => {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a CSV file');
        return;
      }
      
      try {
        const text = await file.text();
        console.log('[Debug] CSV file loaded, parsing...');
        
        // Parse CSV
        parsedData = parseCSV(text);
        console.log('[Debug] Parsed data:', parsedData);
        
        // Display Section 1 (meal boluses)
        displaySection1(parsedData.section1 || []);
        
        // Display Section 2 (auto insulin)
        displaySection2(parsedData.section2 || []);
        
        // Calculate TDD
        calculateTDD();
        
      } catch (err) {
        alert('Error parsing CSV: ' + err.message);
        console.error('[Debug] Parse error:', err);
      }
    };
    
    function displaySection1(section1) {
      const panel = document.getElementById('section1Panel');
      const results = document.getElementById('section1Results');
      
      if (section1.length === 0) {
        results.innerHTML = '<p>‚ö†Ô∏è No meal boluses found in Section 1</p>';
        panel.style.display = 'block';
        return;
      }
      
      // Group by date
      const byDate = {};
      section1.forEach(row => {
        if (!byDate[row.date]) byDate[row.date] = [];
        byDate[row.date].push(row.bolusVolumeDelivered);
      });
      
      let html = `<p><strong>Found ${section1.length} meal boluses</strong></p>`;
      html += '<pre>';
      Object.keys(byDate).sort().reverse().forEach(date => {
        const boluses = byDate[date];
        const total = boluses.reduce((sum, b) => sum + b, 0);
        html += `${date}: ${boluses.length} boluses = ${total.toFixed(2)}E\n`;
      });
      html += '</pre>';
      
      results.innerHTML = html;
      panel.style.display = 'block';
    }
    
    function displaySection2(section2) {
      const panel = document.getElementById('section2Panel');
      const results = document.getElementById('section2Results');
      
      if (section2.length === 0) {
        results.innerHTML = '<p>‚ö†Ô∏è No auto insulin found in Section 2</p>';
        panel.style.display = 'block';
        return;
      }
      
      let html = `<p><strong>Found ${section2.length} auto insulin entries</strong></p>`;
      html += '<pre>';
      section2.forEach(row => {
        html += `${row.date}: ${row.bolusVolumeDelivered}E (${row.bolusSource})\n`;
      });
      html += '</pre>';
      
      results.innerHTML = html;
      panel.style.display = 'block';
    }
    
    function calculateTDD() {
      if (!parsedData || !parsedData.section1 || !parsedData.section2) {
        console.error('[Debug] Missing section data');
        return;
      }
      
      const panel = document.getElementById('tddPanel');
      const results = document.getElementById('tddResults');
      const statsDiv = document.getElementById('tddStats');
      const validationDiv = document.getElementById('validationResults');
      
      try {
        // Calculate TDD for each day
        const tddByDay = calculateDailyTDD(parsedData.section1, parsedData.section2);
        console.log('[Debug] TDD by day:', tddByDay);
        
        // Display per-day TDD
        let html = '';
        const sortedDates = Object.keys(tddByDay).sort().reverse();
        
        sortedDates.forEach(date => {
          const day = tddByDay[date];
          html += `
            <div class="day-card">
              <div class="day-header">
                <strong>${date}</strong>
                <span class="tdd-value">TDD: ${day.tdd.toFixed(1)}E</span>
              </div>
              <div>
                <span class="badge badge-auto">Auto ${day.autoPercent.toFixed(0)}% | ${day.autoInsulin.toFixed(1)}E</span>
                <span class="badge badge-meal">Meal ${day.mealPercent.toFixed(0)}% | ${day.mealBolus.toFixed(1)}E</span>
              </div>
            </div>
          `;
        });
        
        results.innerHTML = html;
        
        // Calculate and display statistics
        const stats = calculateTDDStatistics(tddByDay);
        console.log('[Debug] TDD statistics:', stats);
        
        if (stats) {
          let statsHtml = '<h3>Aggregate Statistics</h3>';
          statsHtml += `
            <div class="stat-row">
              <span class="stat-label">Average TDD:</span>
              <span>${stats.meanTDD.toFixed(1)} ¬± ${stats.sdTDD.toFixed(1)}E</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">TDD Range:</span>
              <span>${stats.minTDD.toFixed(1)} - ${stats.maxTDD.toFixed(1)}E</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Average Auto/Meal:</span>
              <span>${stats.avgAutoPercent.toFixed(0)}% / ${stats.avgMealPercent.toFixed(0)}%</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Data Points:</span>
              <span>${stats.dataPoints} days</span>
            </div>
          `;
          statsDiv.innerHTML = statsHtml;
          statsDiv.style.display = 'block';
        }
        
        // Validation
        const validation = validateTDDData(tddByDay);
        console.log('[Debug] Validation:', validation);
        
        let validationHtml = '';
        if (validation.warnings.length > 0) {
          validationHtml += '<div class="warning">';
          validationHtml += '<strong>‚ö†Ô∏è Warnings:</strong><ul>';
          validation.warnings.forEach(w => {
            validationHtml += `<li>[${w.date}] ${w.message}</li>`;
          });
          validationHtml += '</ul></div>';
        }
        
        if (validation.info.length > 0) {
          validationHtml += '<div class="info">';
          validationHtml += '<strong>‚ÑπÔ∏è Info:</strong><ul>';
          validation.info.forEach(i => {
            validationHtml += `<li>[${i.date}] ${i.message}</li>`;
          });
          validationHtml += '</ul></div>';
        }
        
        if (validationHtml === '') {
          validationHtml = '<div class="info"><strong>‚úÖ All validations passed!</strong></div>';
        }
        
        validationDiv.innerHTML = validationHtml;
        panel.style.display = 'block';
        
      } catch (err) {
        alert('Error calculating TDD: ' + err.message);
        console.error('[Debug] TDD calculation error:', err);
      }
    }
  </script>
</body>
</html>
