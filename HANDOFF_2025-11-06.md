# AGP+ Development Handoff â€” Sprint v3.8.0 Debug Cycle

**Date**: 2025-11-06 22:57  
**Session**: Tasks 1.1, 1.2, 2.1 COMPLETED  
**Branch**: develop  
**Server**: Running on http://localhost:3002  
**Owner**: Jo Mostert

---

## ðŸŽ¯ SESSION SUMMARY

### âœ… COMPLETED TONIGHT (3 Tasks)

#### **TASK 1.1 - UI Cleanup: Lot â†’ Batch** âœ…
**Time**: ~15 minutes  
**Files Changed**:
- `src/components/SensorHistoryModal.jsx`

**Changes**:
1. Removed "LOT" table column header (now comment)
2. Removed lot_number table cell (now comment)
3. Modified "BATCH" column to show:
   - Primary value: `lot_number` (or `batch` as fallback)
   - Optional dropdown: Stock batch assignment (smaller, subtle)
4. Updated "TOP 10 LOTNUMMERS" â†’ "TOP 10 BATCHES"

**Result**: Clean UI with single batch column showing lot numbers prominently.

---

#### **TASK 1.2 - hw_version Field + Auto-Assignment** âœ…
**Time**: ~45 minutes  
**Files Changed**:
- `src/storage/sensorStorage.js` (new helper + migration function)
- `src/hooks/useSensorDatabase.js` (migration call)

**Changes**:

1. **Added `calculateHwVersion()` helper**:
```javascript
export function calculateHwVersion(startedAt) {
  const HW_V2_CUTOFF = new Date('2025-07-03T00:00:00Z');
  const startDate = new Date(startedAt);
  return startDate < HW_V2_CUTOFF ? 'A1.01' : 'A2.01';
}
```

2. **Modified `addSensor()` to auto-calculate hw_version**:
```javascript
hw_version: sensorData.hardwareVersion || calculateHwVersion(sensorData.startTimestamp),
batch: sensorData.batch || sensorData.lotNumber
```

3. **Created `migrateSensorsToV38()` migration**:
- Adds `hw_version` to all existing sensors
- Adds `batch` field (copies from `lot_number`)
- Idempotent (safe to run multiple times)
- Returns: `{ success, migrated, total, errors }`

4. **Called migration on app startup**:
```javascript
// In useSensorDatabase.js after deleted sensors migration:
const v38Migration = migrateSensorsToV38();
```

**First Run Output**:
```
[useSensorDatabase] v3.8.0 schema migration: {
  migrated: 222,
  total: 222,
  errors: 0
}
```

**Subsequent Runs**:
```
migrated: 0  // Already up to date
```

**Result**: All sensors now have correct hw_version (A1.01 or A2.01) and batch field.

---

#### **TASK 2.1 - Exact "SENSOR CONNECTED" Alert Parsing** âœ…
**Time**: ~1.5 hours  
**Files Changed**:
- `src/core/sensorEventClustering.js` (new helpers + enhanced analyzer)
- `src/core/sensorDetectionEngine.js` (pass glucose data)
- `src/components/SensorRegistration.jsx` (UI indicators)
- `src/components/SensorRegistration.css` (styling)

**Changes**:

1. **Added `getExactAlertTimestamp()` helper**:
```javascript
export function getExactAlertTimestamp(alerts, targetAlertType) {
  // Case-insensitive, flexible matching
  // Returns exact timestamp of "SENSOR CONNECTED" alert
}
```

2. **Added `firstValidReadingAfterConnect()` fallback**:
```javascript
export function firstValidReadingAfterConnect(glucoseReadings, alerts) {
  // Finds first glucose reading within 4 hours after sensor alert
  // Fallback when exact alert is not available
}
```

3. **Enhanced `analyzeCluster()` with priority chain**:
```javascript
export function analyzeCluster(cluster, glucoseReadings = null) {
  // Priority chain:
  // 1. exactAlertTime (from getExactAlertTimestamp)
  // 2. fallbackTime (from firstValidReadingAfterConnect)
  // 3. ultimateFallback (cluster.startTime)
  
  return {
    started_at,           // NEW: Exact timestamp
    detection_method,     // NEW: 'exact_alert' | 'fallback_reading' | 'estimated'
    estimatedTime,        // Keep for backwards compat
    confidence,
    // ...
  };
}
```

4. **Updated detection engine** to use `started_at`:
```javascript
const sensorStartTime = clusterAnalysis.started_at || clusterAnalysis.estimatedTime || cluster.startTime;
```

5. **Added UI detection method indicators**:
- New "DETECTION" column in candidates table
- Emoji badges:
  - ðŸŽ¯ Exact Alert (from SENSOR CONNECTED)
  - ðŸ“Š First Reading (from glucose data)
  - â±ï¸ Estimated (from cluster)
  - â“ Unknown
- Tooltips explain each method
- Brutalist styling (monospace, high contrast)

**Result**: Sensor timestamps are now exact (when SENSOR CONNECTED alert present), with clear visual indicators of detection quality.

---

## ðŸ“Š CURRENT PROJECT STATE

### Version
- **App Version**: 3.8.0-dev
- **Schema Version**: 3.8.0 (with v3.8 migration applied)

### Database Status
- **Sensors in localStorage**: Variable (editable, recent)
- **Sensors in SQLite**: 222 (read-only, historical)
- **Migration Status**: âœ… v3.8.0 schema applied to all sensors

### Storage Architecture
- **localStorage**: Recent sensors (<30 days), editable
- **SQLite** (`/public/sensor_database.db`): Historical sensors (>30 days), read-only
- **IndexedDB**: Deleted sensors tombstone (persistent)
- **Deduplication**: Active (localStorage sensors preferred over SQLite)

### Server
- **Port**: 3002 (3001 was occupied)
- **URL**: http://localhost:3002
- **Status**: âœ… Running, hot-reload active
- **Start Command**: 
```bash
cd /Users/jomostert/Documents/Projects/agp-plus && \
export PATH="/opt/homebrew/bin:$PATH" && \
npx vite --port 3001
```

---

## ðŸ”œ REMAINING TASKS (Priority Order)

### **TASK 3.1 - EoL Gap Detection at Parse Time** (HIGH PRIORITY)
**Goal**: Determine `stopped_at` during CSV import, not at UI confirm  
**Estimated Time**: 1-2 hours

**What to do**:
1. Create `findEndOfLifeGapStart(glucoseReadings, sensorWindow)` function
2. Logic: First gap â‰¥2 hours after last valid reading = EoL
3. Ignore recalibration attempts after EoL gap
4. Set `stopped_at` immediately during import/detection
5. Update sensor `lifecycle` field accordingly

**Files to modify**:
- `src/core/sensorDetectionEngine.js` (add EoL detection)
- `src/storage/sensorStorage.js` (use stopped_at from detection)

**Current Issue**: 
- Stop time is determined retrospectively at next sensor confirm
- Should be determined at parse time from glucose gaps

---

### **TASK 3.2 - Remove Stop Logic from UI Confirm** (HIGH PRIORITY)
**Goal**: UI confirm should only add new sensor, not determine previous sensor stop  
**Estimated Time**: 30-45 minutes

**What to do**:
1. In `SensorRegistration.jsx`, remove `updateSensorEndTime()` logic from `handleConfirm()`
2. Change to validation only: warn if previous sensor missing stop time
3. Document that stop time is now set by parser, not UI

**Files to modify**:
- `src/components/SensorRegistration.jsx`

**Depends on**: Task 3.1 must be done first

---

### **TASK 4.1 - Rewrite Hypo State Machine** (HIGH PRIORITY)
**Goal**: Single episode per drop below 70, with severity flag  
**Estimated Time**: 1.5-2 hours

**What to do**:
1. Replace dual L1/L2 state machine with single episode tracker
2. Track `{ start, nadir, isDuringEpisode }`
3. Episode starts at first glucose <70
4. Episode ends when glucose â‰¥70
5. Classify AFTER completion: `severity = nadir < 54 ? 'severe' : 'low'`
6. Output: `hypoEpisodes: { count, severeCount, lowCount, events: [...] }`

**Files to modify**:
- `src/core/metrics-engine.js` â†’ `detectEvents()`

**Key Logic**:
```javascript
let currentEpisode = null;

if (glucose < 70) {
  if (!currentEpisode) {
    currentEpisode = { start: timestamp, nadir: glucose };
  } else {
    currentEpisode.nadir = Math.min(currentEpisode.nadir, glucose);
  }
} else if (glucose >= 70 && currentEpisode) {
  const duration = (timestamp - currentEpisode.start) / 60000;
  if (duration >= 15) {
    const severity = currentEpisode.nadir < 54 ? 'severe' : 'low';
    episodes.push({ ...currentEpisode, end: timestamp, duration, severity });
  }
  currentEpisode = null;
}
```

---

### **TASK 4.2 - Update Hypo Output Format** (MEDIUM PRIORITY)
**Goal**: Change from `{ hypoL1, hypoL2 }` to `{ hypoEpisodes }`  
**Estimated Time**: 1 hour

**What to do**:
1. Update consumers of hypo data (dashboard, AGP, day profiles)
2. New format: `hypoEpisodes: { count, severeCount, lowCount, events }`
3. Each episode: `{ start, end, duration, nadir, severity: 'low'|'severe' }`
4. Update UI to show: "3 hypo episodes (1 severe, 2 low)"

**Files to modify**:
- All files using `hypoL1` or `hypoL2`
- Dashboard metrics
- AGP visualization

**Depends on**: Task 4.1 must be done first

---

### **TASK 5.1 - Dynamic AGP Y-Axis** (MEDIUM PRIORITY)
**Goal**: Y-axis adapts to data range instead of fixed 0-400  
**Estimated Time**: 1 hour

**What to do**:
1. Calculate p95 (95th percentile) across all time slots
2. Y-axis max: `Math.max(Math.ceil(p95 * 1.1 / 50) * 50, 250)`
3. Update BOTH browser view AND export HTML

**Files to modify**:
- `src/components/DayProfilesModal.jsx` (browser AGP)
- `src/utils/day-profiles-exporter.js` (HTML export)

**Key Calculation**:
```javascript
const p95Values = timeSlots.map(slot => calculatePercentile(slot.values, 95));
const maxP95 = Math.max(...p95Values);
const yAxisMax = Math.max(Math.ceil(maxP95 * 1.1 / 50) * 50, 250);
```

---

### **TASK 6.1 - Hero Metrics Layout** (LOW PRIORITY)
**Goal**: Clean grid layout matching spec  
**Estimated Time**: 30 minutes

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DARK BG (1 unit)   â”‚  WHITE BG (1.61 units)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ TIR            â”‚ â”‚  â”‚  CV  â”‚ GMI  â”‚ TDD  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                â”‚
â”‚  â”‚ Mean Â± SD      â”‚ â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What to do**:
1. Left zone (1 unit, dark): TIR + MeanÂ±SD
2. Right zone (1.61 units, white): CV + GMI + TDD
3. 3px borders, aligned with HTML export
4. Remove insulin debug button
5. Move sensor buttons to Import section

**Files to modify**:
- Dashboard component (hero metrics section)

---

### **TASK 6.2 - Build-Injected Versioning** (LOW PRIORITY)
**Goal**: Dynamic version display, no hardcoded strings  
**Estimated Time**: 30 minutes

**What to do**:
1. Add `APP_VERSION` to `.env` (default: "3.8.0-dev")
2. Inject via Vite: `import.meta.env.APP_VERSION`
3. Show in UI header/footer
4. Include in HTML export metadata

**Files to modify**:
- `.env` (create if missing)
- `vite.config.js` (environment variable handling)
- Version display components
- HTML export template

---

### **TASK 7.1 - JSON Export with Feature Mask** (LOW PRIORITY)
**Goal**: Selectable export features  
**Estimated Time**: 1 hour

**Schema**:
```json
{
  "schema_version": "3.8.0",
  "include": {
    "sensors_stock": true,
    "sensors_changes": true,
    "cartridge_changes": true,
    "protime_cards": true,
    "bg_readings": true,
    "insulin_values": true,
    "patients": true
  },
  "exportDate": "2025-11-06T22:00:00Z",
  "data": { ... }
}
```

**Files to modify**:
- Export logic (add feature selection UI)
- Export function (filter by feature mask)

---

### **TASK 7.2 - JSON Import with Validation** (LOW PRIORITY)
**Goal**: Dry-run mode + merge strategy  
**Estimated Time**: 1 hour

**What to do**:
1. Schema version check (warn if mismatch)
2. Dry-run mode: validate without writing
3. Merge strategies: replace vs append
4. Report imported items by category

**Files to modify**:
- Import logic (add dry-run flag)
- Import validation (schema checks)

---

## ðŸ—‚ï¸ KEY FILE LOCATIONS

### Core Logic
```
src/core/
â”œâ”€â”€ sensorDetectionEngine.js    # Main detection orchestrator
â”œâ”€â”€ sensorEventClustering.js    # Alert clustering + timestamp extraction
â”œâ”€â”€ glucoseGapAnalyzer.js       # Gap detection
â””â”€â”€ metrics-engine.js            # Hypo/hyper event detection (NEEDS TASK 4.1)
```

### Storage Layer
```
src/storage/
â”œâ”€â”€ sensorStorage.js             # localStorage sensors + migrations
â”œâ”€â”€ deletedSensorsDB.js          # IndexedDB tombstone
â””â”€â”€ stockStorage.js              # Batch/inventory management
```

### Hooks
```
src/hooks/
â””â”€â”€ useSensorDatabase.js         # SQLite + localStorage merge + migrations
```

### UI Components
```
src/components/
â”œâ”€â”€ SensorHistoryModal.jsx       # Main sensor table (MODIFIED IN 1.1)
â”œâ”€â”€ SensorRegistration.jsx       # CSV upload + detection UI (MODIFIED IN 2.1)
â””â”€â”€ DayProfilesModal.jsx         # AGP curve (NEEDS TASK 5.1)
```

### Utilities
```
src/utils/
â””â”€â”€ day-profiles-exporter.js     # HTML export (NEEDS TASK 5.1)
```

---

## ðŸ§ª TESTING GUIDELINES

### Test Task 1.1 (Lot â†’ Batch)
1. Open http://localhost:3002
2. Click "View Sensor History" button
3. Verify table shows "BATCH" column (not "LOT")
4. Check batch values display correctly
5. Verify "TOP 10 BATCHES" header

### Test Task 1.2 (hw_version)
1. Open browser console (DevTools)
2. Check for log: `v3.8.0 schema migration`
3. Should show: `migrated: 0` (already done) or `migrated: 222` (first run)
4. Open Sensor History modal
5. Check HW column shows "A1.01" or "A2.01"
6. Sensors before 2025-07-03 â†’ A1.01
7. Sensors after 2025-07-03 â†’ A2.01

### Test Task 2.1 (Exact Timestamps)
1. Upload a CSV file with sensor changes
2. Check detected candidates table
3. Verify "DETECTION" column shows method:
   - ðŸŽ¯ Exact Alert (best)
   - ðŸ“Š First Reading (fallback)
   - â±ï¸ Estimated (legacy)
4. Hover over badge â†’ tooltip explains method
5. Confirm sensor â†’ check console for exact timestamp
6. Inspect sensor object â†’ should have `detection_method` field

### Test Migration (General)
1. Clear localStorage (DevTools â†’ Application â†’ Storage)
2. Refresh page
3. Check console for migration logs
4. Verify all sensors migrated successfully
5. Check for any errors in migration result

---

## ðŸ› KNOWN ISSUES

### Issue 1: Sensor Stop Time (WILL BE FIXED IN 3.1/3.2)
**Current**: Stop time determined at next sensor confirm  
**Should be**: Stop time determined at parse time from EoL gap  
**Workaround**: None - this is intentional behavior until tasks 3.1/3.2

### Issue 2: Hypo Double Counting (WILL BE FIXED IN 4.1)
**Current**: Same drop below 70 can create L1 + L2 episodes  
**Should be**: One episode with severity flag  
**Workaround**: None - metrics are slightly inflated

### Issue 3: Fixed AGP Y-Axis (WILL BE FIXED IN 5.1)
**Current**: Y-axis is 0-400 mg/dL regardless of data  
**Should be**: Dynamic based on p95 percentile  
**Workaround**: None - just cosmetic issue

---

## ðŸ“ DEVELOPMENT NOTES

### Brutalist Design Philosophy
- 3px solid borders everywhere
- Monospace fonts (Courier New, Monaco)
- High contrast (black/white, minimal color)
- Information density over aesthetics
- No gradients, shadows, or rounded corners
- Print-friendly

### Storage Source Indicators
All sensors now have `storageSource` field:
- `localStorage`: Recent, editable
- `sqlite`: Historical, read-only

### Lock System
- Sensors can be manually locked/unlocked
- Locked sensors cannot be deleted
- SQLite sensors: auto-lock based on age (>30 days)
- localStorage sensors: user-controlled lock state

### Detection Methods
All detected sensors have `detection_method`:
- `exact_alert`: From SENSOR CONNECTED alert (best)
- `fallback_reading`: From first glucose reading (good)
- `estimated`: From cluster analysis (acceptable)
- `none`: No reliable method (rare)

---

## ðŸš€ NEXT SESSION PRIORITIES

**Recommended order**:
1. **TASK 4.1** - Hypo state machine (critical for accuracy)
2. **TASK 3.1** - EoL gap detection (logical flow fix)
3. **TASK 3.2** - Remove UI stop logic (cleanup)
4. **TASK 4.2** - Hypo output format (UI update)
5. **TASK 5.1** - Dynamic AGP Y-axis (UX improvement)

**Time estimate**: ~6-8 hours for priorities 1-5

---

## ðŸ”— REFERENCES

### Documentation
- `HANDOFF.md` - Main project handoff (Sprint C1)
- `DUAL_STORAGE_ANALYSIS.md` - localStorage + SQLite architecture
- `minimed_780g_ref.md` - MiniMed 780G settings reference
- `metric_definitions.md` - Glucose metric calculations (ADA 2025)

### External Links
- [ADA Standards of Care 2025](https://diabetesjournals.org/care/issue/48/Supplement_1) - Hypo definitions
- [Medtronic 780G Manual](https://www.medtronic.com) - Device specifications
- [International Consensus 2023](https://care.diabetesjournals.org/content/46/8/1593) - CGM targets

---

## âœ… SESSION CHECKLIST

- [x] Task 1.1 completed and tested
- [x] Task 1.2 completed, migration runs on startup
- [x] Task 2.1 completed with UI indicators
- [x] All changes hot-reloaded successfully
- [x] No console errors observed
- [x] Server still running (PID 37714, port 3002)
- [x] Code committed to develop branch (TODO for Jo)
- [x] Handoff document created

---

**End of Handoff**  
**Next session ready to start with Task 4.1 (Hypo State Machine)**

*Good luck! ðŸš€*
