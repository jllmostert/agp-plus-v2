# Bug Fixes - Session 2025-11-14

**Date**: 2025-11-14  
**Issues Addressed**: 3 bugs fixed

---

## âœ… BUG #1: ALL-IN Export Error - FIXED

**Problem**: 
```
"exportAndDownload is not a function"
```

**Root Cause**:
Wrong import path in DataManagementModal.jsx line 272:
```javascript
// WRONG:
const { exportAndDownload } = await import('../storage/masterDatasetStorage');

// CORRECT:
const { exportAndDownload } = await import('../storage/export');
```

**Fix Applied**:
- File: `src/components/DataManagementModal.jsx`
- Changed import path from `masterDatasetStorage` â†’ `export`

**Status**: âœ… FIXED

---

## âœ… BUG #2: No Duplicate Check for Stock Import - FIXED

**Problem**: 
When importing JSON database, duplicate sensor batches (stock) were not filtered out.

**Root Cause**:
The `importJSON()` function in `sensorStorage.js` was:
1. Checking sensor duplicates (good)
2. But then REPLACING entire storage (bad!)
3. No duplicate check for batches at all

**Fix Applied**:
- File: `src/storage/sensorStorage.js`
- Changed from **replace** to **merge** strategy
- Added duplicate detection for batches by:
  - `batch_id` (primary check)
  - `lot_number` (secondary check for same stock)
- Returns detailed summary:
  ```javascript
  {
    sensorsAdded, sensorsSkipped,
    batchesAdded, batchesSkipped
  }
  ```

**Example**:
```
Before:
- Import 10 sensors, 5 batches
- ALL get imported (even if duplicates)
- Old data OVERWRITTEN

After:
- Import 10 sensors (3 new, 7 duplicates)
- Import 5 batches (2 new, 3 duplicates by lot_number)
- Result: 3 sensors added, 7 skipped
         2 batches added, 3 skipped
- Old data PRESERVED
```

**Status**: âœ… FIXED

**UI Update**:
- File: `src/components/panels/SensorHistoryPanel.jsx`
- Import success message now shows:
  ```
  âœ… Import succesvol!
  
  Sensors: 3 toegevoegd, 7 overgeslagen
  Batches: 2 toegevoegd, 3 dubbelen overgeslagen
  ```

---

## â“ BUG #3: Delete Option Missing - NEEDS CLARIFICATION

**Your Comment**: 
> "En ik wil dat de optie er toch is om ook sensoren hier te deleten."

**What I Found**:
- âœ… SensorHistoryPanel **HAS** delete buttons (line 536-549)
- âœ… StockPanel **HAS** delete batch function (line 78-87)
- âœ… Both work correctly (locked sensors protected)

**Question**: 
Waar precies wil je de delete optie hebben? 

Mogelijke locaties:
1. â“ In een modal (welke?)
2. â“ In de Data Management modal?
3. â“ In de Stock cards?
4. â“ Ergens anders?

**Current Delete Functionality**:

**Sensors** (SensorHistoryPanel):
```
[Tabel met sensoren]
Kolommen: # | ğŸ”’ | START | END | DUUR | HW | BATCH | STATUS | DELETE
                                                              ^^^^^^
                                                              ğŸ—‘ï¸ button
```

**Batches** (StockPanel):
```javascript
handleDeleteBatch(batchId, assignedCount) {
  if (assignedCount > 0) {
    confirm("Batch has assigned sensors, delete anyway?");
  }
  deleteBatch(batchId);
}
```

**Status**: â“ AWAITING CLARIFICATION

---

## ğŸ“ FILES MODIFIED

```
src/components/DataManagementModal.jsx
  - Line 272: Fixed export import path

src/storage/sensorStorage.js
  - Lines 317-377: Complete rewrite of importJSON()
  - Added batch duplicate detection
  - Changed from replace to merge strategy

src/components/panels/SensorHistoryPanel.jsx
  - Lines 209-234: Updated import success message
  - Now shows batch duplicate info
```

---

## ğŸ§ª TESTING NEEDED

### Test 1: ALL-IN Export
1. Open Data Management modal
2. Click "ALL-IN CLEANUP"
3. âœ… Should create backup without error
4. âœ… Should show success message

### Test 2: Stock Duplicate Import
1. Export current database (JSON)
2. Import same file again
3. âœ… Should show: "X dubbelen overgeslagen"
4. âœ… No duplicate batches created

### Test 3: Sensor Delete
1. Go to Sensor History panel
2. Find unlocked sensor
3. Click ğŸ—‘ï¸ button
4. âœ… Should delete after confirmation
5. Locked sensor: âœ… Button should be disabled

---

## ğŸš€ DEPLOYMENT

**Ready to test?**
```bash
cd /Users/jomostert/Documents/Projects/agp-plus
npm run dev
```

Then test:
1. ALL-IN button (should work now)
2. Import JSON with duplicates (should skip them)
3. Delete sensors (should already work)

**Ready to commit?**
```bash
git add .
git commit -m "fix: ALL-IN export path + stock duplicate check + import merge strategy"
git push
```

---

## ğŸ¤” FOLLOW-UP QUESTIONS

**Voor Jo:**

1. **Delete functie**: Waar precies wil je een delete optie toevoegen? Ik zie delete buttons al in:
   - Sensor tabel (ğŸ—‘ï¸ button per sensor)
   - Stock panel (delete batch functie)
   
   Mis je delete ergens anders? Screenshot zou helpen!

2. **Batch duplicate check**: Werkt nu op `lot_number` - is dit correct? Of moet er ook op andere velden gecontroleerd worden?

3. **Import strategie**: Nu is het MERGE (oude data behouden + nieuwe toevoegen). Wil je ook een optie voor REPLACE (alles vervangen)?

---

**Klaar voor testing!** ğŸ‰

Laat me weten:
- Werkt ALL-IN nu?
- Werkt duplicate skip?
- Waar moet delete komen?
