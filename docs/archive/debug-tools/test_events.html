<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AGP+ Event Detection Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    button {
      background: #00ff00;
      color: #000;
      border: 3px solid #00ff00;
      padding: 10px 20px;
      font-family: monospace;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #000;
      color: #00ff00;
    }
    #output {
      background: #000;
      border: 3px solid #00ff00;
      padding: 15px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .success { color: #00ff00; }
    .error { color: #ff0000; }
    .warning { color: #ffff00; }
    .info { color: #00aaff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ AGP+ Event Detection Test</h1>
    <p>Test the new clustering logic with your 7-day CSV</p>
    
    <input type="file" id="csvFile" accept=".csv" />
    <br/>
    <button onclick="testEventDetection()">Test Event Detection</button>
    <button onclick="checkStoredEvents()">Check Stored Events</button>
    <button onclick="clearEvents()">Clear Events</button>
    
    <div id="output"></div>
  </div>

  <script type="module">
    window.log = function(message, type = 'info') {
      const output = document.getElementById('output');
      const className = type;
      output.innerHTML += `<span class="${className}">${message}</span>\n`;
      console.log(message);
    };

    window.clearLog = function() {
      document.getElementById('output').innerHTML = '';
    };

    window.testEventDetection = async function() {
      clearLog();
      log('='.repeat(60), 'info');
      log('üß™ TESTING EVENT DETECTION WITH CLUSTERING', 'info');
      log('='.repeat(60), 'info');
      
      const fileInput = document.getElementById('csvFile');
      if (!fileInput.files.length) {
        log('‚ùå Please select a CSV file first', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      log(`\nüìÅ File: ${file.name}`, 'info');
      
      try {
        // Read CSV
        const csvText = await file.text();
        log(`‚úì Read ${csvText.length} characters`, 'success');
        
        // Import modules
        log('\nüì¶ Importing modules...', 'info');
        const { uploadCSVToV3 } = await import('/src/storage/masterDatasetStorage.js');
        
        // Clear existing events
        localStorage.removeItem('agp-device-events');
        log('‚úì Cleared existing events', 'success');
        
        // Upload CSV (triggers detection)
        log('\nüîç Running event detection...', 'info');
        const result = await uploadCSVToV3(csvText);
        
        log('\n‚úÖ Upload complete!', 'success');
        log(`   Readings added: ${result.readingsAdded}`, 'info');
        log(`   Total readings: ${result.totalReadings}`, 'info');
        log(`   Date range: ${result.dateRange?.start} ‚Üí ${result.dateRange?.end}`, 'info');
        
        // Check detected events
        log('\nüìä Detected Events:', 'info');
        const events = JSON.parse(localStorage.getItem('agp-device-events') || '{}');
        
        log(`\nüîπ Sensor Changes: ${events.sensorChanges?.length || 0}`, 'warning');
        if (events.sensorChanges) {
          events.sensorChanges.forEach((event, i) => {
            const date = new Date(event.timestamp);
            log(`   ${i + 1}. ${date.toLocaleString('nl-BE')}`, 'info');
            log(`      Reason: ${event.reason}`, 'info');
            log(`      Source: ${event.source}`, 'info');
          });
        }
        
        log(`\nüîπ Cartridge Changes: ${events.cartridgeChanges?.length || 0}`, 'warning');
        if (events.cartridgeChanges) {
          events.cartridgeChanges.forEach((event, i) => {
            const date = new Date(event.timestamp);
            log(`   ${i + 1}. ${date.toLocaleString('nl-BE')}`, 'info');
            log(`      Reason: ${event.reason}`, 'info');
            log(`      Source: ${event.source}`, 'info');
          });
        }
        
        log('\n' + '='.repeat(60), 'info');
        log('‚úÖ TEST COMPLETE', 'success');
        log('='.repeat(60), 'info');
        
      } catch (err) {
        log(`\n‚ùå ERROR: ${err.message}`, 'error');
        log(err.stack, 'error');
      }
    };

    window.checkStoredEvents = function() {
      clearLog();
      log('üìä Stored Events in localStorage', 'info');
      log('='.repeat(60), 'info');
      
      const events = JSON.parse(localStorage.getItem('agp-device-events') || '{}');
      
      log(`\nSensor Changes: ${events.sensorChanges?.length || 0}`, 'warning');
      log(`Cartridge Changes: ${events.cartridgeChanges?.length || 0}`, 'warning');
      
      log('\nRaw data:', 'info');
      log(JSON.stringify(events, null, 2), 'info');
    };

    window.clearEvents = function() {
      localStorage.removeItem('agp-device-events');
      log('‚úì Cleared all stored events', 'success');
    };
  </script>
</body>
</html>
