# 🚀 START HERE - Next Chat Quick Start

**Date**: 2025-10-31  
**Last Session**: Bug fixes - Duplicate sensors + Lock system  
**Status**: ✅ Fixes committed & pushed  
**Version**: v3.1.0

---

## ⚡ QUICK CONTEXT

### What Just Happened (Previous Session)

Fixed 4 critical bugs:
1. **Duplicate sensors** - localStorage + SQLite merge had no deduplication
2. **CSV "ignore" not working** - Actually worked, but duplicates made it LOOK broken
3. **Delete not working** - Deleted from localStorage, but duplicate in SQLite respawned
4. **Lock system broken** - Icons wrong, toggle failed for old sensors, delete button always enabled

**All fixed and tested!** 🎉

---

## 📁 PROJECT STATUS

### Current State
- **Codebase**: Clean, all fixes committed
- **Version**: v3.1.0 (sensor bug fixes)
- **Branch**: main
- **Last Commit**: `5d22534` - Docs for bug fixes

### Working Files
- ✅ `src/hooks/useSensorDatabase.js` - Dedupe logic
- ✅ `src/storage/sensorStorage.js` - Lock system fixes
- ✅ `src/components/SensorHistoryModal.jsx` - Delete button fixes

### Documentation
- `FIXES_IMPLEMENTED.md` - Complete fix details
- `BUG_ANALYSIS_SUMMARY.md` - Bug analysis + solutions
- `ARCHITECTURE_ISSUES.md` - Data flow problems
- `DUPLICATE_SENSORS_ISSUE.md` - Root cause deep dive
- `CSV_IGNORE_BUTTON_ANALYSIS.md` - CSV import flow

---

## 🔧 DEVELOPMENT SETUP

### Start Server
```bash
cd /Users/jomostert/Documents/Projects/agp-plus
export PATH="/opt/homebrew/bin:$PATH"
npx vite --port 3001
```

### Open in Browser
```
http://localhost:3001
```

### Common Commands
```bash
# Git status
git status

# View recent commits
git log --oneline -5

# Check localStorage
localStorage.getItem('agp-sensor-database')
localStorage.getItem('agp-deleted-sensors')

# Clear localStorage (for testing)
localStorage.clear()
```

---

## 🧪 TESTING STATUS

### What Needs Testing (User Testing)

**Priority 1: Duplicate Fix**
- [ ] Hard refresh (Cmd+Shift+R)
- [ ] Check console: "duplicatesRemoved: X"
- [ ] Import CSV → Check count correct
- [ ] Delete sensor → Stays deleted after refresh

**Priority 2: Lock System**
- [ ] Old sensors (>30d): Show 🔒 icon
- [ ] Recent sensors (≤30d): Show 🔓 icon
- [ ] Toggle lock on recent sensor: Works
- [ ] Toggle lock on old sensor: Error message
- [ ] Delete button: Disabled when locked

**Priority 3: CSV Import**
- [ ] Ignore 4, Confirm 4 → Only 4 added
- [ ] Toast message shows correct count
- [ ] No duplicates after reload

**See FIXES_IMPLEMENTED.md for complete test list**

---

## 🚨 KNOWN ISSUES

### Not Fixed Yet
1. **Chronological #ID Changes** (Low priority)
   - #ID is calculated, not stored
   - Will change after delete/add
   - Design decision: accept for now
   
2. **Old Sensors Can't Toggle** (By design)
   - SQLite-only sensors (>30d) are read-only
   - Can't toggle lock for these
   - Future: "Promote to localStorage" feature

### Potential Issues to Monitor
- **Performance**: Dedupe adds small overhead
- **Edge cases**: What if SQLite sensor becomes recent again?
- **Data consistency**: localStorage vs SQLite sync

---

## 📋 CURRENT ARCHITECTURE

### Data Flow (Simplified)
```
SQLite DB (Guardian.db)
    ↓
useSensorDatabase() hook
    ↓
Merge with deduplication (NEW!)
    ├─ localStorage sensors (recent, editable)
    └─ SQLite sensors (old, read-only)
    ↓
SensorHistoryModal displays all
```

### Lock System Logic
```
Recent sensor (≤30d):
  - In localStorage
  - Can toggle lock ✅
  - Default: unlocked 🔓
  
Old sensor (>30d):
  - In SQLite only
  - Can't toggle (read-only) ⚠️
  - Auto-locked 🔒
```

---

## 🎯 NEXT PRIORITIES

### If Testing Reveals Issues
1. Debug the specific issue
2. Check console logs
3. Verify localStorage state
4. Check if dedupe is working

### If Testing Passes
1. **Phase 6**: Persistent chronological index
2. **Phase 7**: "Promote to localStorage" for old sensors
3. **Phase 8**: Undo delete functionality
4. **Polish**: Improve UX messages

### Future Enhancements
- Persistent #ID (stored in DB)
- Bulk operations (delete multiple)
- Export sensor history
- Advanced filtering/search

---

## 💡 DEVELOPMENT TIPS

### Desktop Commander Usage
```javascript
// Read file
DC: read_file /path/to/file.js

// Edit file  
DC: edit_block (old_string, new_string)

// Search code
DC: start_search "pattern" in /path

// Git commands
DC: start_process "cd /path && git status"
```

### Debugging Sensors
```javascript
// In browser console:

// Check localStorage sensors
const db = JSON.parse(localStorage.getItem('agp-sensor-database'));
console.log('Sensors:', db.sensors.length);

// Check deleted list
const deleted = JSON.parse(localStorage.getItem('agp-deleted-sensors'));
console.log('Deleted:', deleted);

// Check specific sensor
const sensor = db.sensors.find(s => s.sensor_id === 'XXX');
console.log('Sensor:', sensor);
```

### Common Issues
- **Port in use**: `pkill -9 -f vite`
- **Cache issues**: Hard refresh (Cmd+Shift+R)
- **State issues**: `localStorage.clear()` + reload

---

## 📞 IF SOMETHING BREAKS

### Quick Rollback
```bash
cd /Users/jomostert/Documents/Projects/agp-plus
git log --oneline -5
git revert HEAD
git push origin main
```

### Check Last Working State
Last known good commit: `5d22534`

### Debug Steps
1. Check browser console for errors
2. Check server console for errors
3. Check localStorage state
4. Check git log for recent changes
5. Read FIXES_IMPLEMENTED.md for context

---

## 🎬 START DEVELOPMENT

### For New Feature Work
1. Read this file (you're doing it!)
2. Check FIXES_IMPLEMENTED.md for recent changes
3. Start server: `npx vite --port 3001`
4. Open browser: http://localhost:3001
5. Code away!

### For Bug Fixing
1. Read this file
2. Read relevant bug analysis doc
3. Check git log for recent fixes
4. Reproduce bug
5. Debug with console logs

### For Testing
1. Read FIXES_IMPLEMENTED.md testing section
2. Start server
3. Run through test checklist
4. Report findings to Jo

---

## 📚 KEY DOCUMENTATION

**Read These First:**
- `FIXES_IMPLEMENTED.md` - What was just fixed
- `BUG_ANALYSIS_SUMMARY.md` - Why bugs happened

**Read for Deep Understanding:**
- `ARCHITECTURE_ISSUES.md` - Data flow problems
- `DUPLICATE_SENSORS_ISSUE.md` - Root cause analysis
- `CSV_IGNORE_BUTTON_ANALYSIS.md` - Import flow

**Read for Reference:**
- `minimed_780g_ref.md` - Pump settings
- `metric_definitions.md` - AGP metrics

---

## 🎯 SESSION GOALS CHECKLIST

Before ending session, ensure:
- [ ] Code committed to git
- [ ] Code pushed to origin/main
- [ ] Tests documented (if applicable)
- [ ] Handoff updated
- [ ] START_HERE updated
- [ ] No untracked important files
- [ ] Server stopped (if started)

---

**READY TO GO!** 🚀

*Last updated: 2025-10-31 by Claude during bug fix session*
