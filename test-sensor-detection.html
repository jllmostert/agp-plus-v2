<!DOCTYPE html>
<html>
<head>
  <title>AGP+ Sensor Detection Test</title>
  <style>
    body { 
      font-family: 'Courier New', monospace; 
      padding: 20px;
      background: #1a1a1a;
      color: #0f0;
    }
    .box {
      border: 3px solid #0f0;
      padding: 20px;
      margin: 10px 0;
      background: #000;
    }
    h1, h2 { color: #0ff; border-bottom: 2px solid #0ff; }
    button {
      background: #000;
      color: #0f0;
      border: 3px solid #0f0;
      padding: 10px 20px;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0f0; color: #000; }
    pre {
      background: #111;
      padding: 10px;
      border-left: 3px solid #0f0;
      overflow-x: auto;
    }
    .alert { color: #ff0; }
    .sensor { color: #0ff; }
    .error { color: #f00; }
    input[type="file"] {
      background: #000;
      color: #0f0;
      border: 3px solid #0f0;
      padding: 10px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <h1>üî¨ AGP+ Sensor Detection Debug Tool</h1>
  
  <div class="box">
    <h2>üìÅ Step 1: Load CSV</h2>
    <input type="file" id="csvFile" accept=".csv" />
    <button onclick="loadCSV()">Load & Analyze</button>
  </div>

  <div class="box">
    <h2>üìä Step 2: Raw Alerts Found</h2>
    <pre id="rawAlerts">Waiting for CSV...</pre>
  </div>

  <div class="box">
    <h2>‚úÖ Step 3: Valid Sensor Alerts (After Filtering)</h2>
    <pre id="validAlerts">Waiting for CSV...</pre>
  </div>

  <div class="box">
    <h2>üîó Step 4: Clustered Events</h2>
    <pre id="clusteredEvents">Waiting for CSV...</pre>
  </div>

  <div class="box">
    <h2>üíæ Step 5: Upload to V3 & Check Storage</h2>
    <button onclick="uploadToV3()">Upload to V3</button>
    <button onclick="checkStorage()">Check localStorage</button>
    <pre id="uploadResult">Not uploaded yet...</pre>
  </div>

  <script type="module">
    let csvText = null;
    let parsedReadings = null;

    window.loadCSV = async function() {
      const fileInput = document.getElementById('csvFile');
      if (!fileInput.files.length) {
        alert('Please select a CSV file first!');
        return;
      }

      const file = fileInput.files[0];
      csvText = await file.text();

      // Import parser
      const { parseCSV } = await import('/src/core/parsers.js');
      parsedReadings = parseCSV(csvText);

      console.log('Parsed readings:', parsedReadings.length);

      // Step 2: Show ALL alerts
      const allAlerts = parsedReadings
        .filter(r => r.alert && r.date && r.time)
        .map(r => ({
          date: r.date,
          time: r.time,
          alert: r.alert
        }));

      document.getElementById('rawAlerts').textContent = 
        `Found ${allAlerts.length} total alerts:\n\n` +
        allAlerts.map(a => `${a.date} ${a.time} - ${a.alert}`).join('\n');

      // Step 3: Filter for valid sensor alerts
      const { isValidSensorChangeAlert } = await import('/src/utils/eventClustering.js');
      
      const validAlerts = allAlerts.filter(a => isValidSensorChangeAlert(a.alert));

      document.getElementById('validAlerts').innerHTML = 
        `<span class="sensor">Found ${validAlerts.length} VALID sensor change alerts:</span>\n\n` +
        validAlerts.map(a => `<span class="sensor">${a.date} ${a.time} - ${a.alert}</span>`).join('\n');

      // Step 4: Show clustering
      const { deduplicateSensorEvents } = await import('/src/utils/eventClustering.js');
      
      const sensorEvents = allAlerts
        .filter(a => isValidSensorChangeAlert(a.alert))
        .map(a => {
          const [year, month, day] = a.date.split('/').map(Number);
          const [hours, minutes, seconds] = a.time.split(':').map(Number);
          return {
            timestamp: new Date(year, month - 1, day, hours, minutes, seconds),
            date: a.date,
            time: a.time,
            alert: a.alert
          };
        });

      const { confirmedEvents, ambiguousGroups } = deduplicateSensorEvents(sensorEvents);

      document.getElementById('clusteredEvents').innerHTML = 
        `<span class="sensor">Confirmed sensor changes: ${confirmedEvents.length}</span>\n` +
        confirmedEvents.map(e => `  ${e.date} ${e.time} - ${e.alert}`).join('\n') +
        `\n\n<span class="alert">Ambiguous groups: ${ambiguousGroups.length}</span>\n` +
        ambiguousGroups.map(g => 
          `  Date: ${g.date}, Events: ${g.events.length}, Time span: ${g.timeSpan.toFixed(1)} min`
        ).join('\n');
    };

    window.uploadToV3 = async function() {
      if (!csvText) {
        alert('Load CSV first!');
        return;
      }

      const { uploadCSVToV3 } = await import('/src/storage/masterDatasetStorage.js');
      
      try {
        // Clear old events
        localStorage.removeItem('agp-device-events');
        
        const result = await uploadCSVToV3(csvText);
        
        document.getElementById('uploadResult').innerHTML = 
          `<span class="sensor">‚úÖ Upload successful!</span>\n` +
          `Readings added: ${result.readingsAdded}\n` +
          `Total readings: ${result.totalReadings}\n\n` +
          `Now click "Check localStorage" to see stored events...`;
      } catch (err) {
        document.getElementById('uploadResult').innerHTML = 
          `<span class="error">‚ùå Upload failed:</span>\n${err.message}\n\n${err.stack}`;
      }
    };

    window.checkStorage = function() {
      const events = JSON.parse(localStorage.getItem('agp-device-events') || '{}');
      
      const sensorChanges = events.sensorChanges || [];
      const cartridgeChanges = events.cartridgeChanges || [];

      document.getElementById('uploadResult').innerHTML = 
        `<span class="sensor">üì¶ localStorage Contents:</span>\n\n` +
        `<span class="sensor">Sensor Changes: ${sensorChanges.length}</span>\n` +
        sensorChanges.map(s => 
          `  ${s.date} ${s.time} - ${s.alert} (${s.source})`
        ).join('\n') +
        `\n\n<span class="alert">Cartridge Changes: ${cartridgeChanges.length}</span>\n` +
        cartridgeChanges.map(c => 
          `  ${c.date} ${c.time} (${c.source})`
        ).join('\n');
    };
  </script>
</body>
</html>
